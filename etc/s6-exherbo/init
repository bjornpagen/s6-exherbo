#!/bin/execlineb -P
# s6 policy for exherbo

# setup variables
define FILEDIR    "/etc/s6-exherbo"
define SCANDIR    "/run"
define PATH       "/usr/bin:/usr/sbin/:/bin:/sbin"

# welcome banner
if { ${FILEDIR}/banner }

# start init
foreground { s6-echo "\033[35;1m===\033[0m Starting ${FILEDIR}/init" }

# initial environment
foreground { s6-echo ">>> Setting PATH as ${PATH}" }
export PATH ${PATH}

# script setup
foreground { s6-echo ">>> Change directory to /" }
cd /
s6-setsid -qb --
umask 022

# mount tmpfs
foreground { s6-echo ">>> Mounting tmpfs on ${SCANDIR}" }
if { s6-mount -nwt tmpfs -o rw,nosuid,nodev,mode=07555 tmpfs ${SCANDIR} }

# populate initial scan directory
foreground { s6-echo ">>> Populating ${SCANDIR} with ${FILEDIR}/run-image" }
if { s6-hiercopy ${FILEDIR}/run-image ${SCANDIR} }

# setup final environment
foreground { s6-echo ">>> Sourcing env from ${FILEDIR}/env" }
emptyenv -p
s6-envdir -I -- ${FILEDIR}/env

# begin supervision
foreground { s6-echo ">>> Background into ${FILEDIR}/rc.init" }
background {
    s6-setsid --
    redirfd -w 1 ${SCANDIR}/service/s6-svscan-log/fifo
    ${FILEDIR}/rc.init
}
unexport !

foreground { s6-echo ">>> Changing directory to ${SCANDIR}/service" }
cd ${SCANDIR}/service

# done init
background { s6-echo "\033[35;1m===\033[0m Done ${FILEDIR}/init" }

# tell user we are starting s6-svscan before we redirect logs
foreground { s6-echo ">>> Starting s6-svscan" }

# redir logging
foreground { s6-echo ">>> Redirecting stdin to /dev/null" }
redirfd -r 0 /dev/null
foreground { s6-echo ">>> Merging stderr into stdout" }
fdmove -c 2 1
foreground { s6-echo ">>> Redirecting stdout to ${SCANDIR}/service/s6-svscan-log/fifo" }
redirfd -wnb 1 ${SCANDIR}/service/s6-svscan-log/fifo

# start PID 1 supervisor
s6-svscan -st0

